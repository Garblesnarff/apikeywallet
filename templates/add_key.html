{% extends "base.html" %}

{% block content %}
<h2>Add New API Key</h2>
<form id="add-key-form" method="POST" action="{{ url_for('main.add_key') }}">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.key_name.label }}
        {{ form.key_name(class="form-control") }}
        <span class="text-danger" id="key_name-error"></span>
    </div>
    <div class="form-group">
        {{ form.api_key.label }}
        {{ form.api_key(class="form-control") }}
        <span class="text-danger" id="api_key-error"></span>
    </div>
    <div class="form-group">
        {{ form.category.label }}
        {{ form.category(class="form-control") }}
        <span class="text-danger" id="category-error"></span>
    </div>
    {{ form.submit(class="btn btn-primary") }}
</form>

<div id="result-message" class="mt-3"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addKeyForm = document.getElementById('add-key-form');
    if (addKeyForm) {
        addKeyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submission intercepted');
            submitAddKeyForm(this);
        });
    } else {
        console.error('Add key form not found');
    }
});

function submitAddKeyForm(form) {
    console.log('Submitting form...');
    const formData = new FormData(form);
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response received:', response);
        return response.json();
    })
    .then(data => {
        console.log('Data received:', data);
        if (data.success) {
            showFeedback(data.message, 'success');
            form.reset();
        } else {
            if (data.form_errors) {
                for (const [field, errors] of Object.entries(data.form_errors)) {
                    const errorElement = document.getElementById(`${field}-error`);
                    if (errorElement) {
                        errorElement.textContent = errors.join(', ');
                    }
                }
            }
            if (data.error) {
                showFeedback(data.error, 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFeedback('An unexpected error occurred. Please try again.', 'error');
    });
}

function showFeedback(message, type) {
    const feedbackElement = document.createElement('div');
    feedbackElement.textContent = message;
    feedbackElement.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
    document.getElementById('add-key-form').insertAdjacentElement('afterend', feedbackElement);
    setTimeout(() => {
        feedbackElement.remove();
    }, 5000);
}
</script>
{% endblock %}
