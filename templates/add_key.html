{% extends "base.html" %}

{% block content %}
<h2>Add New API Key</h2>
<form id="add-key-form" method="POST" action="{{ url_for('main.add_key') }}">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.key_name.label }}
        {{ form.key_name(class="form-control") }}
        <span class="text-danger" id="key_name-error"></span>
    </div>
    <div class="form-group">
        {{ form.api_key.label }}
        {{ form.api_key(class="form-control") }}
        <span class="text-danger" id="api_key-error"></span>
    </div>
    <div class="form-group">
        {{ form.category.label }}
        {{ form.category(class="form-control") }}
        <span class="text-danger" id="category-error"></span>
    </div>
    {{ form.submit(class="btn btn-primary") }}
</form>

<div id="result-message" class="mt-3"></div>

<script>
document.getElementById('add-key-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Clear previous error messages
    document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
    document.getElementById('result-message').textContent = '';

    fetch("{{ url_for('main.add_key') }}", {
        method: 'POST',
        body: new FormData(this),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('result-message').innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            // Optionally, reset the form
            this.reset();
        } else if (data.error) {
            document.getElementById('result-message').innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
            if (data.form_errors) {
                for (const [field, errors] of Object.entries(data.form_errors)) {
                    document.getElementById(field + '-error').textContent = errors.join(', ');
                }
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('result-message').innerHTML = '<div class="alert alert-danger">An unexpected error occurred. Please try again.</div>';
    });
});
</script>
{% endblock %}
