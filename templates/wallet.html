{% extends "base.html" %}

{% block content %}
<h1>Your API Key Wallet</h1>

<div class="mb-3">
    <a href="{{ url_for('main.add_api_key') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Add New API Key</a>
    <a href="{{ url_for('main.add_category') }}" class="btn btn-secondary"><i class="fas fa-folder-plus"></i> Add New Category</a>
    <!-- Removed the problematic 'Manage Categories' button -->
</div>

{% for category, keys in grouped_keys.items() %}
    <h2>{{ category }}</h2>
    {% if keys %}
        <div class="row">
            {% for key in keys %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">{{ key.key_name }}</h5>
                            <p class="card-text">Added on: {{ key.date_added.strftime('%Y-%m-%d') }}</p>
                            <button class="btn btn-sm btn-primary copy-btn" data-key-id="{{ key.id }}">Copy Key</button>
                            <a href="{{ url_for('main.delete_api_key', key_id=key.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this API key?');">Delete</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No API keys in this category.</p>
    {% endif %}
{% endfor %}

{% if debug %}
    <div class="mt-5">
        <h3>Debug Information</h3>
        <pre>{{ grouped_keys | pprint }}</pre>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const keyId = this.getAttribute('data-key-id');
                fetch(`/get_api_key/${keyId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            navigator.clipboard.writeText(data.api_key).then(() => {
                                alert('API Key copied to clipboard!');
                            }).catch(err => {
                                console.error('Failed to copy text: ', err);
                            });
                        } else {
                            alert('Failed to retrieve API Key');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while fetching the API Key');
                    });
            });
        });
    });
</script>
{% endblock %}
